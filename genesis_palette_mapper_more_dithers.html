<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Genesis Palette Mapper</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font: 13px/1.4 system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  #toolbar { display: flex; align-items: center; gap: 10px; padding: 6px 10px; background: #f0f0f0; border-bottom: 1px solid #ccc; flex-wrap: wrap; flex-shrink: 0; }
  #toolbar label { display: flex; align-items: center; gap: 4px; }
  #toolbar input[type=number] { width: 60px; }
  #toolbar button { padding: 3px 10px; cursor: pointer; }
  #toolbar button:disabled { opacity: 0.4; cursor: default; }
  #toolbar .sep { border-left: 1px solid #bbb; align-self: stretch; margin: 0 2px; }
  #procTime { color: #888; font-size: 11px; }
  #stats { font-size: 11px; color: #555; }
  #dropZone { border: 2px dashed #aaa; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-size: 12px; color: #555; white-space: nowrap; }
  #dropZone:hover, #dropZone.drag-over { border-color: #333; color: #000; }
  #fileInput { display: none; }
  #main { display: flex; flex: 1; overflow: hidden; }
  #canvasArea { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #viewBar { display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: #f8f8f8; border-bottom: 1px solid #ddd; flex-shrink: 0; font-size: 12px; }
  #viewBar button, #zoomBtns button { padding: 2px 7px; cursor: pointer; }
  #viewBar button.active, #zoomBtns button.active { font-weight: bold; outline: 2px solid #555; }
  #canvasPanels { flex: 1; overflow: hidden; position: relative; }
  #sideBySideView { display: flex; gap: 10px; padding: 10px; overflow: auto; height: 100%; }
  .canvas-pane { display: flex; flex-direction: column; gap: 4px; }
  .pane-label { font-size: 11px; color: #666; }
  .canvas-wrap { overflow: auto; border: 1px solid #ccc; background: repeating-conic-gradient(#ddd 0% 25%, #fff 0% 50%) 0 0 / 10px 10px; }
  canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
  #compareView { display: none; flex-direction: column; gap: 6px; padding: 10px; overflow: auto; height: 100%; }
  #compareView.active { display: flex; }
  #compareLabels { display: flex; justify-content: space-between; font-size: 11px; color: #666; }
  #compareContainer { position: relative; overflow: hidden; border: 1px solid #ccc; cursor: col-resize; user-select: none; background: repeating-conic-gradient(#ddd 0% 25%, #fff 0% 50%) 0 0 / 10px 10px; }
  #compareContainer canvas { display: block; position: absolute; top: 0; left: 0; }
  #compareOrigCanvas { position: relative; z-index: 1; }
  #compareOutCanvas { z-index: 2; }
  #compareDivider { position: absolute; top: 0; bottom: 0; width: 2px; background: #333; z-index: 10; }
  #spinner { display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.7); align-items: center; justify-content: center; z-index: 100; }
  #spinner.active { display: flex; }
  #paletteSection { border-top: 1px solid #ddd; flex-shrink: 0; }
  #paletteToggle { padding: 4px 8px; font-size: 11px; cursor: pointer; background: #f8f8f8; display: flex; justify-content: space-between; user-select: none; }
  #paletteToggle:hover { background: #eee; }
  #paletteBody { display: none; padding: 6px 8px; }
  #paletteBody.open { display: block; }
  #paletteGrid { display: grid; grid-template-columns: repeat(32, 16px); gap: 1px; }
  .swatch { width: 16px; height: 16px; }
  .swatch.highlight { outline: 2px solid #000; position: relative; z-index: 1; }
</style>
</head>
<body>

<div id="toolbar">
  <div id="dropZone" onclick="fileInput.click()">Drop / click / paste image</div>
  <input id="fileInput" type="file" accept="image/*" />
  <span class="sep"></span>
  <label><input type="checkbox" id="limitCheck" /> Limit colors</label>
  <label>Max: <input type="number" id="maxColorsInput" min="2" max="512" value="32" /></label>
  <span class="sep"></span>
  <button id="processBtn" disabled>Process</button>
  <button id="downloadBtn" disabled>Download</button>
  <label>Scale: <select id="downloadScale">
    <option value="1">1×</option><option value="2">2×</option><option value="4">4×</option><option value="8">8×</option>
  </select></label>
  <span class="sep"></span>
  <span id="stats">orig: <b id="origCount">—</b> · out: <b id="procCount">—</b> · allowed: <b id="allowedCount">512</b> · <span id="imgDims">—</span></span>
  <span id="procTime"></span>
</div>

<div id="main">
  <div id="canvasArea">
    <div id="viewBar">
      View: <button id="viewSideBySide" class="active">Side-by-side</button>
            <button id="viewCompare">Compare</button>
      &nbsp; Zoom:
      <span id="zoomBtns">
        <button data-zoom="1" class="active">1×</button>
        <button data-zoom="2">2×</button>
        <button data-zoom="4">4×</button>
        <button data-zoom="8">8×</button>
      </span>
    </div>

    <div id="canvasPanels">
      <div id="sideBySideView">
        <div class="canvas-pane"><span class="pane-label">Original</span><div class="canvas-wrap"><canvas id="origCanvas"></canvas></div></div>
        <div class="canvas-pane"><span class="pane-label">Processed</span><div class="canvas-wrap"><canvas id="outCanvas"></canvas></div></div>
      </div>

      <div id="compareView">
        <div id="compareLabels"><span>◀ Original</span><span>Processed ▶</span></div>
        <div id="compareContainer">
          <canvas id="compareOrigCanvas"></canvas>
          <canvas id="compareOutCanvas" style="clip-path:inset(0 50% 0 0)"></canvas>
          <div id="compareDivider" style="left:50%"></div>
        </div>
      </div>

      <div id="spinner">Processing…</div>
    </div>

    <div id="paletteSection">
      <div id="paletteToggle">
        <span>Genesis 512-color palette</span>
        <span id="paletteMeta">0 highlighted — click to expand ▼</span>
      </div>
      <div id="paletteBody"><div id="paletteGrid"></div></div>
    </div>
  </div>
</div>

<script>
function hexToRgb(hex) {
  const m=hex.replace('#','');
  return [parseInt(m.substring(0,2),16),parseInt(m.substring(2,4),16),parseInt(m.substring(4,6),16)];
}
function colorKey(r,g,b) { return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }
function clamp(v,lo,hi) { return Math.max(lo,Math.min(hi,v)); }

const ORIGINAL_PALETTE = [
  "#000000","#000048","#000090","#0000d8","#200000","#200048","#200090","#2000d8","#480000","#480048","#480090","#4800d8","#680000","#680048","#680090","#6800d8",
  "#900000","#900048","#900090","#9000d8","#b00000","#b00048","#b00090","#b000d8","#d80000","#d80048","#d80090","#d800d8","#f80000","#f80048","#f80090","#f800d8",
  "#002400","#002448","#002490","#0024d8","#202400","#202448","#202490","#2024d8","#482400","#482448","#482490","#4824d8","#682400","#682448","#682490","#6824d8",
  "#902400","#902448","#902490","#9024d8","#b02400","#b02448","#b02490","#b024d8","#d82400","#d82448","#d82490","#d824d8","#f82400","#f82448","#f82490","#f824d8",
  "#004800","#004848","#004890","#0048d8","#204800","#204848","#204890","#2048d8","#484800","#484848","#484890","#4848d8","#684800","#684848","#684890","#6848d8",
  "#904800","#904848","#904890","#9048d8","#b04800","#b04848","#b04890","#b048d8","#d84800","#d84848","#d84890","#d848d8","#f84800","#f84848","#f84890","#f848d8",
  "#006c00","#006c48","#006c90","#006cd8","#206c00","#206c48","#206c90","#206cd8","#486c00","#486c48","#486c90","#486cd8","#686c00","#686c48","#686c90","#686cd8",
  "#906c00","#906c48","#906c90","#906cd8","#b06c00","#b06c48","#b06c90","#b06cd8","#d86c00","#d86c48","#d86c90","#d86cd8","#f86c00","#f86c48","#f86c90","#f86cd8",
  "#009000","#009048","#009090","#0090d8","#209000","#209048","#209090","#2090d8","#489000","#489048","#489090","#4890d8","#689000","#689048","#689090","#6890d8",
  "#909000","#909048","#909090","#9090d8","#b09000","#b09048","#b09090","#b090d8","#d89000","#d89048","#d89090","#d890d8","#f89000","#f89048","#f89090","#f890d8",
  "#00b400","#00b448","#00b490","#00b4d8","#20b400","#20b448","#20b490","#20b4d8","#48b400","#48b448","#48b490","#48b4d8","#68b400","#68b448","#68b490","#68b4d8",
  "#90b400","#90b448","#90b490","#90b4d8","#b0b400","#b0b448","#b0b490","#b0b4d8","#d8b400","#d8b448","#d8b490","#d8b4d8","#f8b400","#f8b448","#f8b490","#f8b4d8",
  "#00d800","#00d848","#00d890","#00d8d8","#20d800","#20d848","#20d890","#20d8d8","#48d800","#48d848","#48d890","#48d8d8","#68d800","#68d848","#68d890","#68d8d8",
  "#90d800","#90d848","#90d890","#90d8d8","#b0d800","#b0d848","#b0d890","#b0d8d8","#d8d800","#d8d848","#d8d890","#d8d8d8","#f8d800","#f8d848","#f8d890","#f8d8d8",
  "#00fc00","#00fc48","#00fc90","#00fcd8","#20fc00","#20fc48","#20fc90","#20fcd8","#48fc00","#48fc48","#48fc90","#48fcd8","#68fc00","#68fc48","#68fc90","#68fcd8",
  "#90fc00","#90fc48","#90fc90","#90fcd8","#b0fc00","#b0fc48","#b0fc90","#b0fcd8","#d8fc00","#d8fc48","#d8fc90","#d8fcd8","#f8fc00","#f8fc48","#f8fc90","#f8fcd8",
  "#000020","#000068","#0000b0","#0000f8","#200020","#200068","#2000b0","#2000f8","#480020","#480068","#4800b0","#4800f8","#680020","#680068","#6800b0","#6800f8",
  "#900020","#900068","#9000b0","#9000f8","#b00020","#b00068","#b000b0","#b000f8","#d80020","#d80068","#d800b0","#d800f8","#f80020","#f80068","#f800b0","#f800f8",
  "#002420","#002468","#0024b0","#0024f8","#202420","#202468","#2024b0","#2024f8","#482420","#482468","#4824b0","#4824f8","#682420","#682468","#6824b0","#6824f8",
  "#902420","#902468","#9024b0","#9024f8","#b02420","#b02468","#b024b0","#b024f8","#d82420","#d82468","#d824b0","#d824f8","#f82420","#f82468","#f824b0","#f824f8",
  "#004820","#004868","#0048b0","#0048f8","#204820","#204868","#2048b0","#2048f8","#484820","#484868","#4848b0","#4848f8","#684820","#684868","#6848b0","#6848f8",
  "#904820","#904868","#9048b0","#9048f8","#b04820","#b04868","#b048b0","#b048f8","#d84820","#d84868","#d848b0","#d848f8","#f84820","#f84868","#f848b0","#f848f8",
  "#006c20","#006c68","#006cb0","#006cf8","#206c20","#206c68","#206cb0","#206cf8","#486c20","#486c68","#486cb0","#486cf8","#686c20","#686c68","#686cb0","#686cf8",
  "#906c20","#906c68","#906cb0","#906cf8","#b06c20","#b06c68","#b06cb0","#b06cf8","#d86c20","#d86c68","#d86cb0","#d86cf8","#f86c20","#f86c68","#f86cb0","#f86cf8",
  "#009020","#009068","#0090b0","#0090f8","#209020","#209068","#2090b0","#2090f8","#489020","#489068","#4890b0","#4890f8","#689020","#689068","#6890b0","#6890f8",
  "#909020","#909068","#9090b0","#9090f8","#b09020","#b09068","#b090b0","#b090f8","#d89020","#d89068","#d890b0","#d890f8","#f89020","#f89068","#f890b0","#f890f8",
  "#00b420","#00b468","#00b4b0","#00b4f8","#20b420","#20b468","#20b4b0","#20b4f8","#48b420","#48b468","#48b4b0","#48b4f8","#68b420","#68b468","#68b4b0","#68b4f8",
  "#90b420","#90b468","#90b4b0","#90b4f8","#b0b420","#b0b468","#b0b4b0","#b0b4f8","#d8b420","#d8b468","#d8b4b0","#d8b4f8","#f8b420","#f8b468","#f8b4b0","#f8b4f8",
  "#00d820","#00d868","#00d8b0","#00d8f8","#20d820","#20d868","#20d8b0","#20d8f8","#48d820","#48d868","#48d8b0","#48d8f8","#68d820","#68d868","#68d8b0","#68d8f8",
  "#90d820","#90d868","#90d8b0","#90d8f8","#b0d820","#b0d868","#b0d8b0","#b0d8f8","#d8d820","#d8d868","#d8d8b0","#d8d8f8","#f8d820","#f8d868","#f8d8b0","#f8d8f8",
  "#00fc20","#00fc68","#00fcb0","#00fcf8","#20fc20","#20fc68","#20fcb0","#20fcf8","#48fc20","#48fc68","#48fcb0","#48fcf8","#68fc20","#68fc68","#68fcb0","#68fcf8",
  "#90fc20","#90fc68","#90fcb0","#90fcf8","#b0fc20","#b0fc68","#b0fcb0","#b0fcf8","#d8fc20","#d8fc68","#d8fcb0","#d8fcf8","#f8fc20","#f8fc68","#f8fcb0","#f8fcf8"
];

const PALETTE = ORIGINAL_PALETTE.slice();
const PALETTE_RGB = PALETTE.map(hexToRgb);

const fileInput        = document.getElementById('fileInput');
const processBtn       = document.getElementById('processBtn');
const downloadBtn      = document.getElementById('downloadBtn');
const limitCheck       = document.getElementById('limitCheck');
const maxColorsInput   = document.getElementById('maxColorsInput');
const origCanvas       = document.getElementById('origCanvas');
const outCanvas        = document.getElementById('outCanvas');
const compareOrigCanvas= document.getElementById('compareOrigCanvas');
const compareOutCanvas = document.getElementById('compareOutCanvas');
const compareContainer = document.getElementById('compareContainer');
const compareDivider   = document.getElementById('compareDivider');
const origCountSpan    = document.getElementById('origCount');
const procCountSpan    = document.getElementById('procCount');
const allowedCountSpan = document.getElementById('allowedCount');
const imgDimsSpan      = document.getElementById('imgDims');
const paletteGrid      = document.getElementById('paletteGrid');
const spinner          = document.getElementById('spinner');
const dropZone         = document.getElementById('dropZone');
const procTime         = document.getElementById('procTime');
const paletteMeta      = document.getElementById('paletteMeta');
const downloadScale    = document.getElementById('downloadScale');

let currentImage=null, currentImageName='sprite', latestMapping=null, currentZoom=1;

// Build palette grid
PALETTE.forEach(h => {
  const d=document.createElement('div');
  d.className='swatch'; d.title=h; d.style.background=h;
  paletteGrid.appendChild(d);
});
document.getElementById('paletteToggle').addEventListener('click', () => {
  const body=document.getElementById('paletteBody');
  body.classList.toggle('open');
  paletteMeta.textContent=paletteMeta.textContent.replace(/▼|▲/, body.classList.contains('open')?'▲':'▼');
});

function findNearestInList(r,g,b,listRGB) {
  let bestIdx=0, bestDist=Infinity;
  for (let i=0;i<listRGB.length;i++) {
    const p=listRGB[i], d=(p[0]-r)**2+(p[1]-g)**2+(p[2]-b)**2;
    if (d<bestDist) { bestDist=d; bestIdx=i; }
  }
  return bestIdx;
}

function buildHistogram(imgData) {
  const data=imgData.data, counts=new Map();
  for (let i=0;i<data.length;i+=4) {
    if (data[i+3]===0) continue;
    const k=colorKey(data[i],data[i+1],data[i+2]);
    counts.set(k,(counts.get(k)||0)+1);
  }
  return counts;
}

function countUniqueColors(imgData) {
  const data=imgData.data, s=new Set();
  for (let i=0;i<data.length;i+=4) if (data[i+3]!==0) s.add(colorKey(data[i],data[i+1],data[i+2]));
  return s.size;
}

function chooseAllowedPaletteIndices(countsMap, maxAllowed) {
  const freq=new Map();
  for (const [hex,cnt] of countsMap.entries()) {
    const rgb=hexToRgb(hex), idx=findNearestInList(rgb[0],rgb[1],rgb[2],PALETTE_RGB);
    freq.set(idx,(freq.get(idx)||0)+cnt);
  }
  const chosen=Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,maxAllowed).map(x=>x[0]);
  for (let i=0;i<PALETTE.length&&chosen.length<maxAllowed;i++) if (!chosen.includes(i)) chosen.push(i);
  return chosen;
}

function mapPixels(imgData, allowedIdxs) {
  const {data}=imgData, ar=allowedIdxs.map(i=>PALETTE_RGB[i]);
  for (let i=0;i<data.length;i+=4) {
    if (data[i+3]===0) continue;
    const p=ar[findNearestInList(data[i],data[i+1],data[i+2],ar)];
    data[i]=p[0]; data[i+1]=p[1]; data[i+2]=p[2];
  }
  return imgData;
}

function highlightAllowed(allowedIdxs) {
  Array.from(paletteGrid.children).forEach((el,i)=>el.classList.toggle('highlight',allowedIdxs.includes(i)));
  paletteMeta.textContent=`${allowedIdxs.length} highlighted — click to expand ▼`;
}

function setZoom(z) {
  currentZoom=z;
  document.querySelectorAll('#zoomBtns button').forEach(b=>b.classList.toggle('active',+b.dataset.zoom===z));
  [origCanvas,outCanvas,compareOrigCanvas,compareOutCanvas].forEach(c=>{
    if (c.width>0) { c.style.width=c.width*z+'px'; c.style.height=c.height*z+'px'; }
  });
  updateCompareSize();
}

async function processCurrentImage() {
  if (!currentImage) return;
  spinner.classList.add('active');
  await new Promise(r=>setTimeout(r,0));
  const t0=performance.now(), img=currentImage;

  [origCanvas,outCanvas,compareOrigCanvas,compareOutCanvas].forEach(c=>{c.width=img.width;c.height=img.height;});
  origCanvas.getContext('2d').drawImage(img,0,0);
  compareOrigCanvas.getContext('2d').drawImage(img,0,0);

  const counts=buildHistogram(origCanvas.getContext('2d').getImageData(0,0,img.width,img.height));
  origCountSpan.textContent=counts.size;
  imgDimsSpan.textContent=`${img.width}×${img.height}`;

  let allowedIdxs=[...Array(PALETTE.length).keys()];
  if (limitCheck.checked) allowedIdxs=chooseAllowedPaletteIndices(counts,clamp(parseInt(maxColorsInput.value)||32,2,512));
  allowedCountSpan.textContent=allowedIdxs.length;
  highlightAllowed(allowedIdxs);

  const actx=outCanvas.getContext('2d');
  actx.drawImage(img,0,0);
  const out=mapPixels(actx.getImageData(0,0,img.width,img.height),allowedIdxs);
  actx.putImageData(out,0,0);
  compareOutCanvas.getContext('2d').putImageData(out,0,0);

  procCountSpan.textContent=countUniqueColors(out);
  latestMapping=out;
  downloadBtn.disabled=false;
  procTime.textContent=Math.round(performance.now()-t0)+'ms';
  setZoom(currentZoom);
  spinner.classList.remove('active');
}

// Compare slider
function updateCompareSize() {
  if (!compareOrigCanvas.width) return;
  const w=compareOrigCanvas.width*currentZoom, h=compareOrigCanvas.height*currentZoom;
  compareContainer.style.width=w+'px'; compareContainer.style.height=h+'px';
  [compareOrigCanvas,compareOutCanvas].forEach(c=>{c.style.width=w+'px';c.style.height=h+'px';});
}
let dragging=false;
function setCompareRatio(r) {
  r=Math.max(0,Math.min(1,r));
  compareDivider.style.left=(r*100)+'%';
  compareOutCanvas.style.clipPath=`inset(0 ${((1-r)*100).toFixed(1)}% 0 0)`;
}
compareContainer.addEventListener('mousedown',e=>{dragging=true;e.preventDefault();});
compareContainer.addEventListener('touchstart',()=>dragging=true,{passive:true});
window.addEventListener('mousemove',e=>{if(!dragging)return;const r=compareContainer.getBoundingClientRect();setCompareRatio((e.clientX-r.left)/r.width);});
window.addEventListener('touchmove',e=>{if(!dragging)return;const r=compareContainer.getBoundingClientRect();setCompareRatio((e.touches[0].clientX-r.left)/r.width);},{passive:true});
window.addEventListener('mouseup',()=>dragging=false);
window.addEventListener('touchend',()=>dragging=false);
setCompareRatio(0.5);

// View toggle
document.getElementById('viewSideBySide').addEventListener('click',()=>{
  document.getElementById('sideBySideView').style.display='flex';
  document.getElementById('compareView').classList.remove('active');
  document.getElementById('viewSideBySide').classList.add('active');
  document.getElementById('viewCompare').classList.remove('active');
});
document.getElementById('viewCompare').addEventListener('click',()=>{
  document.getElementById('sideBySideView').style.display='none';
  document.getElementById('compareView').classList.add('active');
  document.getElementById('viewSideBySide').classList.remove('active');
  document.getElementById('viewCompare').classList.add('active');
  updateCompareSize();
});

// Zoom
document.getElementById('zoomBtns').addEventListener('click',e=>{if(e.target.dataset.zoom)setZoom(+e.target.dataset.zoom);});

// File loading
async function loadImageFile(file) {
  if (!file||!file.type.startsWith('image/')) return;
  currentImageName=file.name.replace(/\.[^/.]+$/,'')||'sprite';
  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();
  currentImage=img; processBtn.disabled=false;
  dropZone.textContent=file.name;
  processCurrentImage();
}
fileInput.addEventListener('change',e=>loadImageFile(e.target.files[0]));
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.add('drag-over');}));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{e.preventDefault();dropZone.classList.remove('drag-over');}));
dropZone.addEventListener('drop',e=>loadImageFile(e.dataTransfer.files[0]));
document.body.addEventListener('dragover',e=>e.preventDefault());
document.body.addEventListener('drop',e=>{e.preventDefault();loadImageFile(e.dataTransfer.files[0]);});
document.addEventListener('paste',e=>{
  for (const item of e.clipboardData?.items||[]) { if (item.type.startsWith('image/')) { loadImageFile(item.getAsFile()); break; } }
});

// Controls & download
[limitCheck,maxColorsInput].forEach(el=>el.addEventListener('change',()=>{if(currentImage)processCurrentImage();}));
processBtn.addEventListener('click',()=>processCurrentImage());
downloadBtn.addEventListener('click',()=>{
  if (!latestMapping) return;
  const scale=parseInt(downloadScale.value)||1;
  const c=document.createElement('canvas');
  c.width=outCanvas.width*scale; c.height=outCanvas.height*scale;
  const cx=c.getContext('2d'); cx.imageSmoothingEnabled=false;
  cx.drawImage(outCanvas,0,0,c.width,c.height);
  const a=document.createElement('a');
  a.download=currentImageName+'_genesis'+(scale>1?'_'+scale+'x':'')+'.png';
  a.href=c.toDataURL('image/png'); a.click();
});
</script>
</body>
</html>
