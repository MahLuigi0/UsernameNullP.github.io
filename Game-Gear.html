<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Gear Palette Viewer and Editor/Master System Converter</title>
    <style>
        body{font-family:Arial,sans-serif;display:flex;flex-direction:column;align-items:center;background-color:#f0f0f0}
        .container{display:flex;gap:20px;margin-top:20px}
        .palette-section,.controls-section{background-color:white;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
        .palette-section{width:240px;height:240px}
        #paletteDisplay{height:100%;display:grid;grid-template-columns:repeat(4,1fr)}
        .color-box{width:60px;height:60px;cursor:pointer;box-sizing:border-box}
        .color-box.selected{outline:3px solid gray;outline-offset:-3px;z-index:1}
        button,.file-upload-btn{margin-top:10px;margin-right:5px;padding:5px 10px;background-color:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px}
        button:disabled,.slider:disabled{background-color:#cccccc;cursor:not-allowed}
        .file-upload-btn{background-color:#2196F3;display:inline-block}
        #fileInput{display:none}
        #colorEditor{margin-top:20px}
        .slider{width:100%;opacity:1;transition:opacity 0.2s}
        .slider:disabled{opacity:0.5}
    </style>
</head>
<body>
    <h1>Game Gear Palette Viewer and Editor/Master System Converter</h1>
    <div class="container">
        <div class="palette-section">
            <div id="paletteDisplay"></div>
        </div>
        <div class="controls-section">
            <div id="colorEditor">
                <h3>Edit Color</h3>
                <div>R: <input type="range" class="slider" id="redSlider" min="0" max="15" value="0"> <span id="redValue">0</span></div>
                <div>G: <input type="range" class="slider" id="greenSlider" min="0" max="15" value="0"> <span id="greenValue">0</span></div>
                <div>B: <input type="range" class="slider" id="blueSlider" min="0" max="15" value="0"> <span id="blueValue">0</span></div>
            </div>
            <div id="historyManagement">
                <button id="undoButton">Undo</button>
                <button id="redoButton">Redo</button>
            </div>
            <button id="renderButton">Render to PNG</button>
            <button id="saveButton">Save Palette</button>
            <label for="fileInput" class="file-upload-btn">Upload Palette</label>
            <input type="file" id="fileInput" accept=".pal,.bin">
        </div>
    </div>
    <script>
        let inputFileName='',paletteData=new Uint16Array(16),selectedColorIndex=-1,history=[],historyIndex=-1,isEditing=false,editTimeout=null;
        const controls=['undoButton','redoButton','renderButton','saveButton'];
        const sliders=['redSlider','greenSlider','blueSlider'];
        function updateUIState(f){
            controls.forEach(i=>document.getElementById(i).disabled=!f);
            updateSliderState();
        }
        function updateSliderState(){
            const enabled=paletteData.length>0&&selectedColorIndex!==-1;
            sliders.forEach(i=>{
                const slider=document.getElementById(i);
                slider.disabled=!enabled;
                slider.style.opacity=enabled?1:0.5;
            });
        }
        updateUIState(false);
        function saveState(){if(history.length===0||!arraysEqual(paletteData,history[historyIndex])){history=history.slice(0,historyIndex+1);history.push(new Uint16Array(paletteData));historyIndex++;updateHistoryButtons()}}
        function arraysEqual(a,b){return a.length===b.length&&a.every((v,i)=>v===b[i])}
        function updateHistoryButtons(){document.getElementById('undoButton').disabled=historyIndex<=0;document.getElementById('redoButton').disabled=historyIndex>=history.length-1}
        document.getElementById('fileInput').addEventListener('change',function(e){
            const f=e.target.files[0];
            if(f){
                if(f.size!==32&&f.size!==16){alert("Invalid file size. Game Gear palette should be 32 bytes, Master System palette should be 16 bytes.");this.value='';return}
                inputFileName=f.name;
                const r=new FileReader();
                r.onload=function(e){
                    if(f.size===32){
                        paletteData=new Uint16Array(e.target.result);
                    }else{
                        const msData=new Uint8Array(e.target.result);
                        paletteData=new Uint16Array(16);
                        for(let i=0;i<16;i++){
                            const c=msData[i];
                            const r=(c&3)*5,g=((c>>2)&3)*5,b=((c>>4)&3)*5;
                            paletteData[i]=(b<<8)|(g<<4)|r;
                        }
                    }
                    history=[new Uint16Array(paletteData)];
                    historyIndex=0;
                    selectedColorIndex=-1;
                    displayPalette();
                    updateUIState(true);
                    updateHistoryButtons();
                };
                r.readAsArrayBuffer(f);
            }else{updateUIState(false)}
        });
        function displayPalette(){
            const p=document.getElementById('paletteDisplay');
            p.innerHTML='';
            for(let i=0;i<paletteData.length;i++){
                const c=paletteData[i];
                const r=(c&15)*17,g=((c>>4)&15)*17,b=((c>>8)&15)*17;
                const box=document.createElement('div');
                box.className='color-box';
                box.style.backgroundColor=`rgb(${r},${g},${b})`;
                box.dataset.index=i;
                box.addEventListener('click',selectColor);
                if(i===selectedColorIndex)box.classList.add('selected');
                p.appendChild(box);
            }
        }
        function selectColor(e){
            const clickedIndex=parseInt(e.target.dataset.index);
            selectedColorIndex=clickedIndex===selectedColorIndex?-1:clickedIndex;
            updateColorEditor();
            displayPalette();
            updateSliderState();
        }
        function updateColorEditor(){
            if(selectedColorIndex===-1||selectedColorIndex>=paletteData.length)return;
            const c=paletteData[selectedColorIndex];
            document.getElementById('redSlider').value=c&15;
            document.getElementById('greenSlider').value=(c>>4)&15;
            document.getElementById('blueSlider').value=(c>>8)&15;
            updateSliderValues(false);
        }
        function updateSliderValues(s=true){
            sliders.forEach(i=>{
                const v=parseInt(document.getElementById(i).value);
                document.getElementById(i.replace('Slider','Value')).textContent=v;
            });
            updateColor(s);
        }
        function updateColor(s=true){
            if(selectedColorIndex===-1)return;
            const r=parseInt(document.getElementById('redSlider').value);
            const g=parseInt(document.getElementById('greenSlider').value);
            const b=parseInt(document.getElementById('blueSlider').value);
            paletteData[selectedColorIndex]=(b<<8)|(g<<4)|r;
            if(s){
                if(isEditing)clearTimeout(editTimeout);
                isEditing=true;
                editTimeout=setTimeout(()=>{saveState();isEditing=false},500);
            }
            displayPalette();
        }
        sliders.forEach(i=>document.getElementById(i).addEventListener('input',()=>updateSliderValues(true)));
        document.getElementById('undoButton').addEventListener('click',function(){
            if(historyIndex>0){
                historyIndex--;
                paletteData=new Uint16Array(history[historyIndex]);
                selectedColorIndex=-1;
                displayPalette();
                updateHistoryButtons();
                updateColorEditor();
                updateSliderState();
            }
        });
        document.getElementById('redoButton').addEventListener('click',function(){
            if(historyIndex<history.length-1){
                historyIndex++;
                paletteData=new Uint16Array(history[historyIndex]);
                selectedColorIndex=-1;
                displayPalette();
                updateHistoryButtons();
                updateColorEditor();
                updateSliderState();
            }
        });
        document.getElementById('renderButton').addEventListener('click',function(){
            const c=document.createElement('canvas');
            const x=c.getContext('2d');
            c.width=160;
            c.height=160;
            for(let i=0;i<paletteData.length;i++){
                const color=paletteData[i];
                const r=(color&15)*17,g=((color>>4)&15)*17,b=((color>>8)&15)*17;
                x.fillStyle=`rgb(${r},${g},${b})`;
                x.fillRect((i%4)*40,(Math.floor(i/4))*40,40,40);
            }
            const k=document.createElement('a');
            k.download=inputFileName.replace(/\.[^/.]+$/,"")+".png";
            k.href=c.toDataURL();
            k.click();
        });
        document.getElementById('saveButton').addEventListener('click',function(){
            const b=new Blob([paletteData.buffer],{type:'application/octet-stream'});
            const l=document.createElement('a');
            l.download=inputFileName.replace(/\.[^/.]+$/,"")+".pal";
            l.href=URL.createObjectURL(b);
            l.click();
        });
    </script>
</body>
</html>
