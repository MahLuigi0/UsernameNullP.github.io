<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Game Gear Palette Editor</title>
    <style>
        body{font-family:Arial,sans-serif;display:flex;flex-direction:column;align-items:center;background-color:#f0f0f0}
        .container{display:flex;gap:20px;margin-top:20px}
        .palette-section,.controls-section{background-color:white;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
        .palette-section{width:480px;height:400px;overflow-y:auto}
        #paletteDisplay{display:flex;flex-direction:column}
        .palette-row{display:flex;align-items:center}
        .color-box{width:30px;height:30px;cursor:pointer}
        .color-box.selected{outline:3px solid gray;outline-offset:-3px;z-index:1}
        button,.file-upload-btn{margin-top:10px;margin-right:5px;padding:5px 10px;background-color:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;font-size:14px}
        button:disabled,.slider:disabled{background-color:#cccccc;cursor:not-allowed}
        .file-upload-btn{background-color:#2196F3;display:inline-block}
        #fileInput{display:none}
        #colorEditor{margin-top:20px}
        .slider{-webkit-appearance:none;width:calc(100% - 50px);height:10px;border-radius:5px;outline:none;opacity:1;transition:opacity 0.2s}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#808080;cursor:pointer}
        .slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#808080;cursor:pointer}
        .slider:disabled{opacity:0.5}
        #redSlider{background:linear-gradient(to right, #000000, #FF0000)}
        #greenSlider{background:linear-gradient(to right, #000000, #00FF00)}
        #blueSlider{background:linear-gradient(to right, #000000, #0000FF)}
        .button-row{display:flex;justify-content:flex-start;margin-top:10px}
        .color-preview{width:30px;height:30px;display:inline-block;margin-left:10px;vertical-align:middle}
        .slider-container{display:flex;align-items:center;margin-bottom:10px}
    </style>
</head>
<body>
    <h1>Ultimate Game Gear Palette Editor</h1>
    <div class="container">
        <div class="palette-section">
            <div id="paletteDisplay"></div>
        </div>
        <div class="controls-section">
            <div id="colorEditor">
                <h3>Edit Color</h3>
                <div class="slider-container">
                    R: <input type="range" class="slider" id="redSlider" min="0" max="15" value="0">
                    <span id="redValue">0</span>
                    <div class="color-preview" id="redPreview"></div>
                </div>
                <div class="slider-container">
                    G: <input type="range" class="slider" id="greenSlider" min="0" max="15" value="0">
                    <span id="greenValue">0</span>
                    <div class="color-preview" id="greenPreview"></div>
                </div>
                <div class="slider-container">
                    B: <input type="range" class="slider" id="blueSlider" min="0" max="15" value="0">
                    <span id="blueValue">0</span>
                    <div class="color-preview" id="bluePreview"></div>
                </div>
            </div>
            <div class="button-row">
                <button id="undoButton">Undo</button>
                <button id="redoButton">Redo</button>
                <button id="toggleRowButton">+</button>
            </div>
            <div class="button-row">
                <button id="exportPngButton">Export PNG</button>
                <button id="exportPaletteButton">Export Palette</button>
                <label for="fileInput" class="file-upload-btn">Upload Palette/PNG</label>
                <input type="file" id="fileInput" accept=".pal,.bin,.png">
            </div>
        </div>
    </div>
    <script>
        let inputFileName='',paletteData=new Uint16Array(16),selectedColorIndex=-1,history=[],historyIndex=-1,isEditing=false,editTimeout=null;
        const controls=['undoButton','redoButton','exportPngButton','exportPaletteButton','toggleRowButton'];
        const sliders=['redSlider','greenSlider','blueSlider'];
        function updateUIState(f){
            controls.forEach(i=>document.getElementById(i).disabled=!f);
            updateSliderState();
            updateToggleRowButton();
        }
        function updateSliderState(){
            const enabled=paletteData.length>0&&selectedColorIndex!==-1;
            sliders.forEach(i=>{
                const slider=document.getElementById(i);
                slider.disabled=!enabled;
                slider.style.opacity=enabled?1:0.5;
            });
            if(!enabled) resetSliders();
            else updateSliderValues(false);
        }
        function resetSliders(){
            sliders.forEach(i=>{
                document.getElementById(i).value=0;
                document.getElementById(i.replace('Slider','Value')).textContent='0';
            });
            document.getElementById('redPreview').style.backgroundColor='rgb(0,0,0)';
            document.getElementById('greenPreview').style.backgroundColor='rgb(0,0,0)';
            document.getElementById('bluePreview').style.backgroundColor='rgb(0,0,0)';
        }
        function updateToggleRowButton(){
            const button=document.getElementById('toggleRowButton');
            button.textContent=paletteData.length===16?'+':'-';
        }
        updateUIState(false);
        resetSliders();
        function saveState(){if(history.length===0||!arraysEqual(paletteData,history[historyIndex])){history=history.slice(0,historyIndex+1);history.push(new Uint16Array(paletteData));historyIndex++;updateHistoryButtons()}}
        function arraysEqual(a,b){return a.length===b.length&&a.every((v,i)=>v===b[i])}
        function updateHistoryButtons(){document.getElementById('undoButton').disabled=historyIndex<=0;document.getElementById('redoButton').disabled=historyIndex>=history.length-1}
        document.getElementById('fileInput').addEventListener('change',function(e){
            const f=e.target.files[0];
            if(f){
                inputFileName=f.name;
                const r=new FileReader();
                if(f.type==="image/png"){
                    r.onload=function(e){
                        const img=new Image();
                        img.onload=function(){
                            if(img.width!==128||(img.height!==8&&img.height!==16)){
                                alert("Invalid PNG size. Image should be 128x8 or 128x16.");
                                return;
                            }
                            const canvas=document.createElement('canvas');
                            canvas.width=img.width;
                            canvas.height=img.height;
                            const ctx=canvas.getContext('2d');
                            ctx.drawImage(img,0,0);
                            const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
                            paletteData=new Uint16Array(img.height===8?16:32);
                            for(let i=0;i<paletteData.length;i++){
                                const x=(i%16)*8;
                                const y=Math.floor(i/16)*8;
                                const r=imageData.data[(y*canvas.width+x)*4];
                                const g=imageData.data[(y*canvas.width+x)*4+1];
                                const b=imageData.data[(y*canvas.width+x)*4+2];
                                paletteData[i]=rgbToGameGear(r,g,b);
                            }
                            history=[new Uint16Array(paletteData)];
                            historyIndex=0;
                            selectedColorIndex=-1;
                            displayPalette();
                            updateUIState(true);
                            updateHistoryButtons();
                        };
                        img.src=e.target.result;
                    };
                    r.readAsDataURL(f);
                }else{
                    if(f.size!==64&&f.size!==32&&f.size!==16){alert("Invalid file size. Game Gear palette should be 32 or 64 bytes, Master System palette should be 16 bytes.");this.value='';return}
                    r.onload=function(e){
                        if(f.size===64||f.size===32){
                            paletteData=new Uint16Array(e.target.result);
                        }else{
                            const msData=new Uint8Array(e.target.result);
                            paletteData=new Uint16Array(16);
                            for(let i=0;i<16;i++){
                                const c=msData[i];
                                const r=(c&3)*5,g=((c>>2)&3)*5,b=((c>>4)&3)*5;
                                paletteData[i]=(b<<8)|(g<<4)|r;
                            }
                        }
                        history=[new Uint16Array(paletteData)];
                        historyIndex=0;
                        selectedColorIndex=-1;
                        displayPalette();
                        updateUIState(true);
                        updateHistoryButtons();
                    };
                    r.readAsArrayBuffer(f);
                }
            }else{updateUIState(false)}
        });
        function rgbToGameGear(r,g,b){
            r=Math.round(r/17);
            g=Math.round(g/17);
            b=Math.round(b/17);
            return (b<<8)|(g<<4)|r;
        }
        function displayPalette(){
            const p=document.getElementById('paletteDisplay');
            p.innerHTML='';
            for(let row=0;row<paletteData.length/16;row++){
                const rowDiv=document.createElement('div');
                rowDiv.className='palette-row';
                for(let col=0;col<16;col++){
                    const i=row*16+col;
                    const c=paletteData[i];
                    const r=(c&15)*17,g=((c>>4)&15)*17,b=((c>>8)&15)*17;
                    const box=document.createElement('div');
                    box.className='color-box';
                    box.style.backgroundColor=`rgb(${r},${g},${b})`;
                    box.dataset.index=i;
                    box.addEventListener('click',selectColor);
                    if(i===selectedColorIndex)box.classList.add('selected');
                    rowDiv.appendChild(box);
                }
                p.appendChild(rowDiv);
            }
        }
        function toggleRow(){
            if(paletteData.length===16){
                const newRow=new Uint16Array(16);
                paletteData=new Uint16Array([...paletteData,...newRow]);
            }else{
                paletteData=new Uint16Array(paletteData.slice(0,16));
            }
            saveState();
            displayPalette();
            updateUIState(true);
        }
        function selectColor(e){
            const clickedIndex=parseInt(e.target.dataset.index);
            selectedColorIndex=clickedIndex===selectedColorIndex?-1:clickedIndex;
            updateColorEditor();
            displayPalette();
            updateSliderState();
        }
        function updateColorEditor(){
            if(selectedColorIndex===-1||selectedColorIndex>=paletteData.length){
                resetSliders();
                return;
            }
            const c=paletteData[selectedColorIndex];
            document.getElementById('redSlider').value=c&15;
            document.getElementById('greenSlider').value=(c>>4)&15;
            document.getElementById('blueSlider').value=(c>>8)&15;
            updateSliderValues(false);
        }
        function updateSliderValues(s=true){
            const r=parseInt(document.getElementById('redSlider').value);
            const g=parseInt(document.getElementById('greenSlider').value);
            const b=parseInt(document.getElementById('blueSlider').value);
            document.getElementById('redValue').textContent=r;
            document.getElementById('greenValue').textContent=g;
            document.getElementById('blueValue').textContent=b;
            document.getElementById('redPreview').style.backgroundColor=`rgb(${r*17},0,0)`;
            document.getElementById('greenPreview').style.backgroundColor=`rgb(0,${g*17},0)`;
            document.getElementById('bluePreview').style.backgroundColor=`rgb(0,0,${b*17})`;
            if(s&&selectedColorIndex!==-1)updateColor(s);
        }
        function updateColor(s=true){
            if(selectedColorIndex===-1)return;
            const r=parseInt(document.getElementById('redSlider').value);
            const g=parseInt(document.getElementById('greenSlider').value);
            const b=parseInt(document.getElementById('blueSlider').value);
            paletteData[selectedColorIndex]=(b<<8)|(g<<4)|r;
            if(s){
                if(isEditing)clearTimeout(editTimeout);
                isEditing=true;
                editTimeout=setTimeout(()=>{saveState();isEditing=false},500);
            }
            displayPalette();
        }
        sliders.forEach(i=>document.getElementById(i).addEventListener('input',()=>updateSliderValues(true)));
        document.getElementById('undoButton').addEventListener('click',function(){
            if(historyIndex>0){
                historyIndex--;
                paletteData=new Uint16Array(history[historyIndex]);
                selectedColorIndex=-1;
                displayPalette();
                updateHistoryButtons();
                updateColorEditor();
                updateUIState(true);
            }
        });
        document.getElementById('redoButton').addEventListener('click',function(){
            if(historyIndex<history.length-1){
                historyIndex++;
                paletteData=new Uint16Array(history[historyIndex]);
                selectedColorIndex=-1;
                displayPalette();
                updateHistoryButtons();
                updateColorEditor();
                updateUIState(true);
            }
        });
        document.getElementById('toggleRowButton').addEventListener('click',toggleRow);
        document.getElementById('exportPngButton').addEventListener('click',function(){
            const c=document.createElement('canvas');
            const x=c.getContext('2d');
            const colorsPerRow=16;
            const rows=Math.ceil(paletteData.length/colorsPerRow);
            c.width=colorsPerRow*8;
            c.height=rows*8;
            for(let i=0;i<paletteData.length;i++){
                const color=paletteData[i];
                const r=(color&15)*17,g=((color>>4)&15)*17,b=((color>>8)&15)*17;
                x.fillStyle=`rgb(${r},${g},${b})`;
                x.fillRect((i%colorsPerRow)*8,Math.floor(i/colorsPerRow)*8,8,8);
            }
            const k=document.createElement('a');
            k.download=inputFileName.replace(/\.[^/.]+$/,"")+".png";
            k.href=c.toDataURL();
            k.click();
        });
        document.getElementById('exportPaletteButton').addEventListener('click',function(){
            const b=new Blob([paletteData.buffer],{type:'application/octet-stream'});
            const l=document.createElement('a');
            l.download=inputFileName.replace(/\.[^/.]+$/,"")+".pal";
            l.href=URL.createObjectURL(b);
            l.click();
        });
    </script>
</body>
</html>
